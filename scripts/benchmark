#!/bin/sh

# Benchmark script for udu implementations
# Compares GNU du against C and Zig versions of UDU using hyperfine
# Uses /home/ copying instead of drop caches so root is no needed

set -ex

# The Directory we test on
DIR="/home/"
TMP="/tmp/t_home_t"

# Ensure we have a clean slate
rm -rf "$TMP"

echo "Copying $DIR to $TMP for benchmarking..."
cp -r "$DIR" "$TMP"

# Cold cache benchmark
echo "Running cold cache benchmark..."
hyperfine --export-markdown=bench-cold.md \
    --runs 1 \
    --ignore-failure \
    --command-name "GNU du" "du -sh $TMP" \
    --command-name "Zig udu" "./zig/zig-out/bin/udu $TMP" \
    --command-name "C udu" "./build/udu $TMP"

# Warm cache benchmark
echo "Running warm cache benchmark..."
hyperfine --export-markdown=bench-warm.md \
    --warmup 1 \
    --runs 1 \
    --ignore-failure \
    --command-name "GNU du" "du -sh $DIR" \
    --command-name "Zig udu" "./zig/zig-out/bin/udu $DIR" \
    --command-name "C udu" "./build/udu $DIR"

# Combine results
echo "Generating combined report..."
cat > BENCHMARKS.md << 'EOF'
# Benchmarks

Benchmarked with [hyperfine](https://github.com/sharkdp/hyperfine), using this [script](./scripts/benchmark).

## System

ARM64 Arch Linux, 8-core, 8 GB DDR4 RAM machine

## Toolchains

GCC: 15.2.1 (OpenMP: GNU-libgomp 4.5)
Clang: 21.1.5 (OpenMP: LLVM-libomp 5.1)
Zig: 0.15.2

## Build Commands

C (`udu`):

```bash
cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_OPENMP=ON -DENABLE_LTO=ON
cmake --build build
```

Zig (`udu`):

```bash
zig build -Doptimize=ReleaseFast
```

## Results

Cold cache:

EOF

cat bench-cold.md >> BENCHMARKS.md

echo "" >> BENCHMARKS.md
echo "Warm cache:" >> BENCHMARKS.md
echo "" >> BENCHMARKS.md

cat bench-warm.md >> BENCHMARKS.md

cat >> BENCHMARKS.md << 'EOF'

Note: C binary times were measured with GCC builds. Clang may provide different runtime performance.
EOF

echo "Benchmark complete. Results written to BENCHMARKS.md"

# Clean up
rm -rf "$TMP"
rm -f bench-cold.md bench-warm.md
