name: Release

on:
  push:
    tags:
      - 'udu@*'

permissions:
  contents: write

jobs:
  linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y gcc cmake make tar
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_OPENMP=ON -DSTATIC_OPENMP=ON -DENABLE_LTO=ON
          cmake --build build 
          strip build/udu
          tar -czf udu-linux-x86_64.tar.gz -C build udu -C $GITHUB_WORKSPACE README.md LICENSE
      - uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: udu-linux-x86_64.tar.gz

  linux-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y gcc cmake make tar
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DENABLE_OPENMP=ON -DSTATIC_OPENMP=ON -DENABLE_LTO=ON
          cmake --build build 
          strip build/udu
          tar -czf udu-linux-aarch64.tar.gz -C build udu -C $GITHUB_WORKSPACE README.md LICENSE
      - uses: actions/upload-artifact@v4
        with:
          name: linux-aarch64
          path: udu-linux-aarch64.tar.gz

  macos-x64:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
      - run: brew install gcc cmake make
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc -DENABLE_OPENMP=ON -DSTATIC_OPENMP=ON -DENABLE_LTO=ON
          cmake --build build 
          strip build/udu
          tar -czf udu-macos-x86_64.tar.gz -C build udu -C $GITHUB_WORKSPACE README.md LICENSE
      - uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64
          path: udu-macos-x86_64.tar.gz

  macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: brew install gcc cmake make
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc -DENABLE_OPENMP=ON -DSTATIC_OPENMP=ON -DENABLE_LTO=ON
          cmake --build build 
          strip build/udu
          tar -czf udu-macos-arm64.tar.gz -C build udu -C $GITHUB_WORKSPACE README.md LICENSE
      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: udu-macos-arm64.tar.gz

  windows-x64:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          install: |
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-make
            mingw-w64-ucrt-x86_64-7zip
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc -DENABLE_OPENMP=ON -DSTATIC_OPENMP=ON -DENABLE_LTO=ON
          cmake --build build 
          strip build/udu.exe
          7z a udu-windows-x86_64.zip build/udu.exe README.md LICENSE
      - uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: udu-windows-x86_64.zip

  windows-arm64:
    runs-on: windows-11-arm
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: CLANGARM64
          install: |
            mingw-w64-clang-aarch64-llvm
            mingw-w64-clang-aarch64-llvm-openmp
            mingw-w64-clang-aarch64-clang
            mingw-w64-clang-aarch64-cmake
            mingw-w64-clang-aarch64-make
            mingw-w64-clang-aarch64-7zip
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang -DENABLE_OPENMP=ON -DSTATIC_OPENMP=ON -DENABLE_LTO=ON
          cmake --build build 
          strip build/udu.exe
          7z a udu-windows-aarch64.zip build/udu.exe README.md LICENSE
      - uses: actions/upload-artifact@v4
        with:
          name: windows-arm64
          path: udu-windows-aarch64.zip

  release:
    needs: [linux-x64, linux-arm64, macos-x64, macos-arm64, windows-x64, windows-arm64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - run: mv artifacts/* .
      - run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          TITLE="${VERSION#*@}"
          gh release create "$VERSION" \
            --repo="${GITHUB_REPOSITORY}" \
            --title="$TITLE" \
            --generate-notes \
            --notes "**NOTE:** `udu-windows-aarch64.zip` was built on MSYS2 using the LLVM toolchain, which may lead to runtime crashes (see [#2](https://github.com/gnualmalki/udu/issues/2)). And GCC is not available through MSYS2 for ARM64 machines." \
            *.tar.gz *.zip
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
