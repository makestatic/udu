name: release

on:
  push:
    tags: ['udu@*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install GCC 15
        run: |
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt-get update
          sudo apt-get install -y gcc-15 g++-15 cmake
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc-15 -DCMAKE_CXX_COMPILER=g++-15
          cmake --build build -v
      - run: |
          mkdir -p artifact
          cp README.md LICENSE artifact/ 2>/dev/null || true
          cp build/udu artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-x86_64-linux
          path: artifact/

  build-linux-arm64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install aarch64 GCC 15
        run: |
          sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
          sudo apt-get update
          sudo apt-get install -y gcc-15-aarch64-linux-gnu g++-15-aarch64-linux-gnu cmake
      - run: |
          cmake -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_SYSTEM_NAME=Linux \
            -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
            -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc-15 \
            -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++-15
          cmake --build build -v
      - run: |
          mkdir -p artifact
          cp README.md LICENSE artifact/ 2>/dev/null || true
          cp build/udu artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-aarch64-linux
          path: artifact/

  build-macos-x64:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
      - run: brew install gcc cmake
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc-15 -DCMAKE_CXX_COMPILER=g++-15
          cmake --build build -v
      - run: |
          mkdir -p artifact
          cp README.md LICENSE artifact/ 2>/dev/null || true
          cp build/udu artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-x86_64-macos
          path: artifact/

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: brew install gcc cmake
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc-15 -DCMAKE_CXX_COMPILER=g++-15
          cmake --build build -v
      - run: |
          mkdir -p artifact
          cp README.md LICENSE artifact/ 2>/dev/null || true
          cp build/udu artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-aarch64-macos
          path: artifact/

  build-windows-x64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          install: mingw-w64-ucrt-x86_64-gcc mingw-w64-ucrt-x86_64-cmake
      - shell: msys2 {0}
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -v
      - shell: msys2 {0}
        run: |
          mkdir -p artifact
          cp README.md LICENSE artifact/ 2>/dev/null || true
          cp build/udu.exe artifact/
          cp build/libgomp-1.dll artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-x86_64-windows
          path: artifact/

  release:
    needs:
      - build-linux-x64
      - build-linux-arm64
      - build-macos-x64
      - build-macos-arm64
      - build-windows-x64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - run: |
          cd artifacts
          for d in */; do
            base=$(basename "$d")
            tar czf "../${base}.tar.gz" "$base"
          done
          cd ..
          sha256sum *.tar.gz > checksums.txt
      - uses: softprops/action-gh-release@v2
        with:
          body: |
            Official udu release built with GCC 15

            NOTE: Windows packages already include the required OPENMP dll
          files: |
            *.tar.gz
            checksums.txt
