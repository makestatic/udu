name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y clang libomp-dev
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang
          cmake --build build
          strip build/udu
          tar -czf udu-linux-x86_64.tar.gz -C build udu -C $GITHUB_WORKSPACE README.md LICENSE
      - uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: udu-linux-x86_64.tar.gz

  linux-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y clang libomp-dev
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang
          cmake --build build
          strip build/udu
          tar -czf udu-linux-aarch64.tar.gz -C build udu -C $GITHUB_WORKSPACE README.md LICENSE
      - uses: actions/upload-artifact@v4
        with:
          name: linux-aarch64
          path: udu-linux-aarch64.tar.gz

  macos-x64:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
      - run: brew install llvm libomp
      - run: |
          export PATH="/usr/local/opt/llvm/bin:$PATH"
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang
          cmake --build build
          strip build/udu
          tar -czf udu-macos-x86_64.tar.gz -C build udu -C $GITHUB_WORKSPACE README.md LICENSE
      - uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64
          path: udu-macos-x86_64.tar.gz

  macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: brew install llvm libomp
      - run: |
          export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang
          cmake --build build
          strip build/udu
          tar -czf udu-macos-arm64.tar.gz -C build udu -C $GITHUB_WORKSPACE README.md LICENSE
      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: udu-macos-arm64.tar.gz

  windows-x64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: CLANG64
          install: |
            mingw-w64-clang-x86_64-clang
            mingw-w64-clang-x86_64-cmake
            mingw-w64-clang-x86_64-ninja
            mingw-w64-clang-x86_64-llvm-openmp
      - shell: msys2 {0}
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang
          cmake --build build
          strip build/udu.exe
          tar -czf udu-windows-x86_64.tar.gz -C build udu.exe -C $GITHUB_WORKSPACE README.md LICENSE
      - uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: udu-windows-x86_64.tar.gz

  windows-arm64:
    runs-on: windows-11-arm
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: CLANGARM64
          install: |
            mingw-w64-clang-aarch64-clang
            mingw-w64-clang-aarch64-cmake
            mingw-w64-clang-aarch64-ninja
            mingw-w64-clang-aarch64-llvm-openmp
      - shell: msys2 {0}
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=clang
          cmake --build build
          strip build/udu.exe
          tar -czf udu-windows-aarch64.tar.gz -C build udu.exe -C $GITHUB_WORKSPACE README.md LICENSE
      - uses: actions/upload-artifact@v4
        with:
          name: windows-aarch64
          path: udu-windows-aarch64.tar.gz

  release:
    needs: [linux-x64, linux-arm64, macos-x64, macos-arm64, windows-x64, windows-arm64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
      - run: mv */*.tar.gz .
      - run: |
          gh release create ${{ github.ref_name }} \
            --repo=${{ github.repository }} \
            --title="Release ${{ github.ref_name }}" \
            --generate-notes \
            *.tar.gz
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
