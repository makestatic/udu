name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # Linux GCC static
          - runner: ubuntu-latest
            os: linux
            arch: x86_64
          - runner: ubuntu-24.04-arm
            os: linux
            arch: aarch64
          
          # macOS Clang static
          - runner: macos-15-intel
            os: macos
            arch: x86_64
          - runner: macos-latest
            os: macos
            arch: arm64
          
          # Windows Clang MSYS2
          - runner: windows-latest
            os: windows
            arch: x86_64
            msys: CLANG64
          - runner: windows-11-arm
            os: windows
            arch: aarch64
            msys: CLANGARM64

    steps:
      - uses: actions/checkout@v4

      # Install LLVM+OpenMP
      - if: runner.os == 'macOS'
        run: brew install llvm libomp 

      # Setup MSYS2 Clang
      - if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msys }}
          install: mingw-w64-${{ matrix.msys == 'CLANG64' && 'x86_64' || 'clangarm64' }}-clang mingw-w64-${{ matrix.msys == 'CLANG64' && 'x86_64' || 'clangarm64' }}-cmake mingw-w64-${{ matrix.msys == 'CLANG64' && 'x86_64' || 'clangarm64' }}-ninja

      # Build Linux/macOS
      - name: Build (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            # GCC static OpenMP
            OPTS="-DCMAKE_C_FLAGS='-static -fopenmp' -DCMAKE_EXE_LINKER_FLAGS='-static'"
          else
            # Clang static OpenMP
            OPTS="-DCMAKE_C_COMPILER=$(brew --prefix llvm)/bin/clang -DOpenMP_C_FLAGS='-fopenmp' -DOpenMP_omp_LIBRARY=$(brew --prefix libomp)/lib/libomp.a -DCMAKE_C_FLAGS='-I$(brew --prefix libomp)/include'"
          fi
          
          cmake -B build -DCMAKE_BUILD_TYPE=Release $OPTS
          cmake --build build
          strip build/udu
          tar -czf udu-${{ matrix.os }}-${{ matrix.arch }}.tar.gz -C build udu

      # Build Windows
      - name: Build (Windows)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          # Clang static OpenMP
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_FLAGS='-static -fopenmp' -DCMAKE_EXE_LINKER_FLAGS='-static'
          cmake --build build
          strip build/udu.exe
          tar -czf udu-${{ matrix.os }}-${{ matrix.arch }}.tar.gz -C build udu.exe

      # Upload build artifact
      - uses: actions/upload-artifact@v4
        with:
          name: udu-${{ matrix.os }}-${{ matrix.arch }}
          path: udu-${{ matrix.os }}-${{ matrix.arch }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Download build artifacts
      - uses: actions/download-artifact@v4
      
      # Move to root
      - run: mv */*.tar.gz .
      
      # Create GitHub release
      - run: |
          gh release create ${{ github.ref_name }} \
            --repo=${{ github.repository }} \
            --title="${{ github.event.repository.name }} ${{ github.ref_name }}" \
            --generate-notes \
            *.tar.gz
