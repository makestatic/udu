name: release

on:
  push:
    tags: ['udu@*']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download xPack GCC x64
        run: |
          wget https://github.com/xpack-dev-tools/gcc-xpack/releases/download/v15.2.0-1/xpack-gcc-15.2.0-1-linux-x64.tar.gz
          tar -xf xpack-gcc-15.2.0-1-linux-x64.tar.gz
      - run: |
          GCC_BIN="${GITHUB_WORKSPACE}/xpack-gcc-15.2.0-1/bin/gcc"
          GXX_BIN="${GITHUB_WORKSPACE}/xpack-gcc-15.2.0-1/bin/g++"
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER="$GCC_BIN" -DCMAKE_CXX_COMPILER="$GXX_BIN" -DENABLE_OPENMP=ON -DENABLE_LTO=ON
          cmake --build build -v
      - run: |
          mkdir -p artifact
          cp README.md LICENSE artifact/ 2>/dev/null || true
          cp build/udu artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-x86_64-linux
          path: artifact/

  build-linux-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - name: Download xPack GCC ARM64
        run: |
          wget https://github.com/xpack-dev-tools/gcc-xpack/releases/download/v15.2.0-1/xpack-gcc-15.2.0-1-linux-arm64.tar.gz
          tar -xf xpack-gcc-15.2.0-1-linux-arm64.tar.gz
      - run: |
          GCC_BIN="${GITHUB_WORKSPACE}/xpack-gcc-15.2.0-1/bin/gcc"
          GXX_BIN="${GITHUB_WORKSPACE}/xpack-gcc-15.2.0-1/bin/g++"
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER="$GCC_BIN" -DCMAKE_CXX_COMPILER="$GXX_BIN" -DENABLE_OPENMP=ON -DENABLE_LTO=ON
          cmake --build build -v
      - run: |
          mkdir -p artifact
          cp README.md LICENSE artifact/ 2>/dev/null || true
          cp build/udu artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-aarch64-linux
          path: artifact/

  build-macos-x64:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
      - run: brew install gcc cmake
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc-15 -DCMAKE_CXX_COMPILER=g++-15 -DENABLE_OPENMP=ON -DENABLE_LTO=ON
          cmake --build build -v
      - run: |
          mkdir -p artifact
          cp README.md LICENSE artifact/ 2>/dev/null || true
          cp build/udu artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-x86_64-macos
          path: artifact/

  build-macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: brew install gcc cmake
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc-15 -DCMAKE_CXX_COMPILER=g++-15 -DENABLE_OPENMP=ON -DENABLE_LTO=ON
          cmake --build build -v
      - run: |
          mkdir -p artifact
          cp README.md LICENSE artifact/ 2>/dev/null || true
          cp build/udu artifact/
      - uses: actions/upload-artifact@v4
        with:
          name: udu-aarch64-macos
          path: artifact/

  build-windows-x64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          install: mingw-w64-ucrt-x86_64-gcc mingw-w64-ucrt-x86_64-cmake
      - shell: msys2 {0}
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build -v
      - shell: msys2 {0}
        run: |
          mkdir -p artifact
          cp README.md LICENSE artifact/ 2>/dev/null || true
          cp build/udu.exe artifact/
          cp build/libgomp-1.dll artifact/ 2>/dev/null || true
      - shell: pwsh
        run: |
          Compress-Archive -Path artifact\* -DestinationPath udu-x86_64-windows.zip
      - uses: actions/upload-artifact@v4
        with:
          name: udu-x86_64-windows
          path: udu-x86_64-windows.zip

  release:
    needs:
      - build-linux-x64
      - build-linux-arm64
      - build-macos-x64
      - build-macos-arm64
      - build-windows-x64
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
      - run: |
          cd artifacts
          for d in */; do
            base=$(basename "$d")
            if [ -f "$d/udu-x86_64-windows.zip" ]; then
              cp "$d/udu-x86_64-windows.zip" "../${base}.zip"
            else
              tar czf "../${base}.tar.gz" -C "$d" .
            fi
          done
          cd ..
      - uses: softprops/action-gh-release@v2
        with:
          body: |
            Official udu release built with GCC 15

            NOTE: Windows packages already contains the required OPENMP dll
          files: |
            *.tar.gz
            *.zip
