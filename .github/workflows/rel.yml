name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  # Linux x86_64
  linux-x64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y clang libomp-dev
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_C_FLAGS='-static -fopenmp -static-openmp' \
            -DCMAKE_EXE_LINKER_FLAGS='-static -fopenmp -static-openmp'
          cmake --build build
          strip build/udu
          tar -czf udu-linux-x86_64.tar.gz -C build udu
      - uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: udu-linux-x86_64.tar.gz

  # Linux ARM64
  linux-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - run: sudo apt-get update && sudo apt-get install -y clang libomp-dev
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_C_FLAGS='-static -fopenmp -static-openmp' \
            -DCMAKE_EXE_LINKER_FLAGS='-static -fopenmp -static-openmp'
          cmake --build build
          strip build/udu
          tar -czf udu-linux-aarch64.tar.gz -C build udu
      - uses: actions/upload-artifact@v4
        with:
          name: linux-aarch64
          path: udu-linux-aarch64.tar.gz

  # macOS x86_64
  macos-x64:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
      - run: brew install llvm libomp
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=/usr/local/opt/llvm/bin/clang \
            -DOpenMP_C_FLAGS='-fopenmp -static-openmp' \
            -DOpenMP_omp_LIBRARY=/usr/local/opt/libomp/lib/libomp.a \
            -DCMAKE_C_FLAGS='-I/usr/local/opt/libomp/include -static -fopenmp -static-openmp' \
            -DCMAKE_EXE_LINKER_FLAGS='-static -fopenmp -static-openmp'
          cmake --build build
          strip build/udu
          tar -czf udu-macos-x86_64.tar.gz -C build udu
      - uses: actions/upload-artifact@v4
        with:
          name: macos-x86_64
          path: udu-macos-x86_64.tar.gz

  # macOS ARM64
  macos-arm64:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - run: brew install llvm libomp
      - run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_COMPILER=/opt/homebrew/opt/llvm/bin/clang \
            -DOpenMP_C_FLAGS='-fopenmp -static-openmp' \
            -DOpenMP_omp_LIBRARY=/opt/homebrew/opt/libomp/lib/libomp.a \
            -DCMAKE_C_FLAGS='-I/opt/homebrew/opt/libomp/include -static -fopenmp -static-openmp' \
            -DCMAKE_EXE_LINKER_FLAGS='-static -fopenmp -static-openmp'
          cmake --build build
          strip build/udu
          tar -czf udu-macos-arm64.tar.gz -C build udu
      - uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: udu-macos-arm64.tar.gz

  # Windows x86_64
  windows-x64:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: CLANG64
          install: mingw-w64-x86_64-clang mingw-w64-x86_64-cmake mingw-w64-x86_64-ninja
      - shell: msys2 {0}
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_FLAGS='-static -fopenmp -static-openmp' \
            -DCMAKE_EXE_LINKER_FLAGS='-static -fopenmp -static-openmp'
          cmake --build build
          strip build/udu.exe
          tar -czf udu-windows-x86_64.tar.gz -C build udu.exe
      - uses: actions/upload-artifact@v4
        with:
          name: windows-x86_64
          path: udu-windows-x86_64.tar.gz

  # Windows ARM64
  windows-arm64:
    runs-on: windows-11-arm
    steps:
      - uses: actions/checkout@v4
      - uses: msys2/setup-msys2@v2
        with:
          msystem: CLANGARM64
          install: mingw-w64-clangarm64-clang mingw-w64-clangarm64-cmake mingw-w64-clangarm64-ninja
      - shell: msys2 {0}
        run: |
          cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_FLAGS='-static -fopenmp -static-openmp' \
            -DCMAKE_EXE_LINKER_FLAGS='-static -fopenmp -static-openmp'
          cmake --build build
          strip build/udu.exe
          tar -czf udu-windows-aarch64.tar.gz -C build udu.exe
      - uses: actions/upload-artifact@v4
        with:
          name: windows-aarch64
          path: udu-windows-aarch64.tar.gz

  # Create release
  release:
    needs: [linux-x64, linux-arm64, macos-x64, macos-arm64, windows-x64, windows-arm64]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
      - run: mv */*.tar.gz .
      - run: |
          gh release create ${{ github.ref_name }} \
            --repo=${{ github.repository }} \
            --title="Release ${{ github.ref_name }}" \
            --generate-notes \
            *.tar.gz
