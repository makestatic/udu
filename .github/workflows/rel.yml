name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          # Linux - GCC, static 
          - runner: ubuntu-latest
            os: linux
            arch: x86_64
          - runner: ubuntu-24.04-arm
            os: linux
            arch: aarch64
          
          # macOS - Clang, static 
          - runner: macos-15-intel
            os: macos
            arch: x86_64
          - runner: macos-latest
            os: macos
            arch: arm64
          
          # Windows - Clang, static 
          - runner: windows-latest
            os: windows
            arch: x86_64
            msys: CLANG64
          - runner: windows-11-arm
            os: windows
            arch: aarch64
            msys: CLANGARM64

    steps:
      - uses: actions/checkout@v4

      # LLVM toolchain for macOS
      - if: runner.os == 'macOS'
        run: brew install llvm libomp 

      # LLVM toolchain for Windows
      - if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: ${{ matrix.msys }}
          install: mingw-w64-${{ matrix.msys == 'CLANG64' && 'x86_64' || 'clangarm64' }}-clang mingw-w64-${{ matrix.msys == 'CLANG64' && 'x86_64' || 'clangarm64' }}-cmake mingw-w64-${{ matrix.msys == 'CLANG64' && 'x86_64' || 'clangarm64' }}-ninja

      # Configure, build, strip, and package binary
      - name: Build
        shell: ${{ runner.os == 'Windows' && 'msys2 {0}' || 'bash' }}
        run: |
          # Set platform-specific CMake options
          if [ "${{ runner.os }}" = "Linux" ]; then
            # Linux: GCC with static OpenMP 
            OPTS="-DCMAKE_C_FLAGS='-static -fopenmp' -DCMAKE_EXE_LINKER_FLAGS='-static'"
          elif [ "${{ runner.os }}" = "macOS" ]; then
            # macOS: Clang with static OpenMP
            OPTS="-DCMAKE_C_COMPILER=$(brew --prefix llvm)/bin/clang -DOpenMP_C_FLAGS='-fopenmp' -DOpenMP_omp_LIBRARY=$(brew --prefix libomp)/lib/libomp.a -DCMAKE_C_FLAGS='-I$(brew --prefix libomp)/include'"
          else
            # Windows: Clang with static OpenMP
            OPTS="-DCMAKE_C_FLAGS='-static -fopenmp' -DCMAKE_EXE_LINKER_FLAGS='-static'"
          fi
          
          # Build 
          cmake -B build -DCMAKE_BUILD_TYPE=Release $OPTS
          cmake --build build
          
          # Strip 
          [ "${{ runner.os }}" = "Windows" ] && EXE=".exe" || EXE=""
          strip build/udu$EXE

          # Package
          tar -czf udu-${{ matrix.os }}-${{ matrix.arch }}.tar.gz -C build udu$EXE

      # Upload artifact for release job
      - uses: actions/upload-artifact@v4
        with:
          name: udu-${{ matrix.os }}-${{ matrix.arch }}
          path: udu-${{ matrix.os }}-${{ matrix.arch }}.tar.gz

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Download all build artifacts
      - uses: actions/download-artifact@v4
      
      # Move archives to root directory
      - run: mv */*.tar.gz .
      
      # Create GitHub release and ship all binaries
      - run: |
          gh release create ${{ github.ref_name }} \
            --repo=${{ github.repository }} \
            --title="${{ github.event.repository.name }} ${{ github.ref_name }}" \
            --generate-notes \
            *.tar.gz
